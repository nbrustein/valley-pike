#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 1 ]; then
  echo "Usage: host-bin/new-workdir <branch> [directory]"
  exit 1
fi

branch="$1"
shift

dir="${1:-../valley-pike-$branch}"

if git show-ref --verify --quiet "refs/heads/$branch"; then
  git worktree add "$dir" "$branch"
elif git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
  git worktree add -b "$branch" "$dir" "origin/$branch"
else
  git worktree add -b "$branch" "$dir"
fi

(
  cd "$dir"
  host-bin/setup
)

code "$dir"
