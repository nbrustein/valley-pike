#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 1 ]; then
  echo "Usage: host-bin/worktree-new <branch> [directory]"
  exit 1
fi

branch="$1"
shift

dir="${1:-../valley-pike-$branch}"

# Find a value for WEB_PORT that is not already being used
# by an existing worktree
used_ports=" 3000 "
while IFS= read -r path; do
  env_file="$path/.env"
  if [ -f "$env_file" ]; then
    port="$(awk -F= '/^WEB_PORT=/{print $2; exit}' "$env_file" | tr -d '[:space:]')"
    if [ -n "$port" ]; then
      used_ports=" $used_ports$port "
      continue
    fi
  fi
  used_ports=" $used_ports 3000 "
done < <(git worktree list --porcelain | awk '/^worktree /{print substr($0,10)}')

port=3001
while echo "$used_ports" | grep -q " $port "; do
  port=$((port + 1))
done

if git show-ref --verify --quiet "refs/heads/$branch"; then
  git worktree add "$dir" "$branch"
elif git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
  git worktree add -b "$branch" "$dir" "origin/$branch"
else
  git worktree add -b "$branch" "$dir"
fi

(
  cd "$dir"
  printf "WEB_PORT=%s\n" "$port" > .env
  host-bin/setup
)

code "$dir"
