#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: host-bin/worktree-rm <branch-name>"
}

if [ $# -ne 1 ]; then
  usage
  exit 1
fi

branch_name="$1"
branch_ref="refs/heads/$branch_name"

top_level="$(git rev-parse --show-toplevel)"

worktree_path="$({
  git worktree list --porcelain
} | awk -v branch_ref="$branch_ref" '
$1 == "worktree" {
  worktree = substr($0, 10)
}
$1 == "branch" && $2 == branch_ref {
  print worktree
  exit
}
')"

if [ -z "$worktree_path" ]; then
  echo "No worktree found for branch: $branch_name"
  exit 1
fi

if [ "$worktree_path" = "$top_level" ]; then
  echo "Refusing to remove the main worktree: $worktree_path"
  exit 1
fi

if [ -f "$worktree_path/docker-compose.yml" ]; then
  (
    cd "$worktree_path"
    docker compose down -v --remove-orphans
  )
fi

git worktree remove "$worktree_path"
git worktree prune

echo "Removed worktree for branch '$branch_name': $worktree_path"
